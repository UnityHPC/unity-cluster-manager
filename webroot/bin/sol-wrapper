#!/bin/bash
#
# Environment vars must already be set (A file in this case)
#
export TERM=xterm

UCM_IPMI_NAME=$(echo `cat tmp/solPrefs | grep node` | cut -d ":" -f 2)
UCM_IPMI_HOST=$(echo `cat tmp/solPrefs | grep host` | cut -d ":" -f 2)
UCM_IPMI_USER=$(echo `cat tmp/solPrefs | grep user` | cut -d ":" -f 2)
UCM_IPMI_PASS=$(echo `cat tmp/solPrefs | grep pass` | cut -d ":" -f 2)

while true; do
  read -p "Press enter to start a serial connection to $UCM_IPMI_NAME..."
  clear

  echo "Starting serial connection to $UCM_IPMI_NAME [$UCM_IPMI_HOST]"
  ipmitool -I lanplus -H $UCM_IPMI_HOST -U $UCM_IPMI_USER -P $UCM_IPMI_PASS sol activate
  if [ $? -ne 0 ]; then
    echo -n "Deactivate existing connection [y,n]? "
    read deac
    if [ "$deac" = "y" ]; then
      ipmitool -I lanplus -H $UCM_IPMI_HOST -U $UCM_IPMI_USER -P $UCM_IPMI_PASS sol deactivate
      ipmitool -I lanplus -H $UCM_IPMI_HOST -U $UCM_IPMI_USER -P $UCM_IPMI_PASS sol activate
    else
      exit
    fi
  fi
  clear
done
